suite: SSH Vault token secret
templates:
  - ssh-vault-token-secret.yaml
set:
  ssh:
    ca:
      vault:
        address: "https://vault.example.com:8200"
        role: "my-role"
tests:
  - it: should not render when `enabled` is false
    set:
      ssh:
        enabled: false
        ca:
          vault:
            auth:
              token: "my-token"
    asserts:
      # Empty document
      - notExists:
          path: kind
  - it: should not render when `enabled` is true but using an existing token secret
    set:
      ssh:
        enabled: true
        ca:
          vault:
            auth:
              existingTokenSecret: "my-existing-secret"
    asserts:
      # Empty document
      - notExists:
          path: kind
  - it: should render when `enabled` is true and token is specified
    set:
      ssh:
        enabled: true
        ca:
          vault:
            auth:
              token: "my-token"
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-ssh-vault-token
      - equal:
          path: data
          value:
            token: bXktdG9rZW4=
  - it: should error when token is empty
    set:
      ssh:
        enabled: true
        ca:
          vault:
            auth:
              token: ""
    asserts:
      - failedTemplate:
          errorPattern: "ssh.ca.vault.auth.token is required"
  - it: should error when both token and existingTokenSecret are specified
    set:
      ssh:
        enabled: true
        ca:
          vault:
            auth:
              token: "my-token"
              existingTokenSecret: "my-existing-secret"
    asserts:
      - failedTemplate:
          errorPattern: "at '/ssh/ca/vault/auth': 'oneOf' failed, subschemas 0, 1 matched"
