suite: Certificate Authority Certificate
templates:
  - ca-cert.yaml
set:
  tls:
    autoGenerated:
      enabled: true
      engine: cert-manager
tests:
  - it: should not render when `autoGenerated` is disabled
    set:
      tls:
        autoGenerated:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: should not render when `engine` is helm
    set:
      tls:
        autoGenerated:
          engine: helm
    asserts:
      - hasDocuments:
          count: 0
  - it: should not render when `existingSecret` is provided
    set:
      tls:
        existingSecret: "my-tls-secret"
    asserts:
      - hasDocuments:
          count: 0
  - it: should render using self-signed CA
    asserts:
      - matchSnapshot: {}
  - it: should use `existingIssuer` when provided
    set:
      tls:
        autoGenerated:
          enabled: true
          engine: cert-manager
          certManager:
            existingIssuer: existing-issuer
            existingIssuerKind: ClusterIssuer
    asserts:
      - equal:
          path: spec.issuerRef.name
          value: existing-issuer
        documentSelector:
          path: kind
          value: Certificate
      - equal:
          path: spec.issuerRef.kind
          value: ClusterIssuer
        documentSelector:
          path: kind
          value: Certificate
      - hasDocuments:
          # 1 Certificate + 1 Issuer
          count: 2
