suite: TLS secret
templates:
  - tls-secret.yaml
set:
  tls:
    cert: "my-tls-cert"
    key: "my-tls-key"
    ca: "my-ca-cert"
tests:
  - it: should require `enabled` value
    set:
      tls:
        autoGenerated:
          enabled: null
    asserts:
      - failedTemplate:
          errorPattern: 'tls.autoGenerated: enabled is required'
  - it: should require `engine` value
    set:
      tls:
        autoGenerated:
          engine: null
    asserts:
      - failedTemplate:
          errorPattern: 'tls.autoGenerated: engine is required'
  - it: should not allow other `engine` value
    set:
      tls:
        autoGenerated:
          engine: foo
    asserts:
      - failedTemplate:
          errorPattern: 'tls.autoGenerated.engine must be one of the following: "helm", "cert-manager"'
  - it: should not render when `engine` is cert-manager
    set:
      tls:
        autoGenerated:
          enabled: true
          engine: cert-manager
    asserts:
      # Empty document
      - notExists:
          path: kind
  - it: should not render when `existingSecret` is provided
    set:
      tls:
        existingSecret: "my-tls-secret"
    asserts:
      # Empty document
      - notExists:
          path: kind
  - it: should use provided certificates when `autoGenerated` is false
    set:
      tls:
        autoGenerated:
          enabled: false
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-tls
      - equal:
          path: data
          value:
            tls.crt: bXktdGxzLWNlcnQ=
            tls.key: bXktdGxzLWtleQ==
            ca.crt: bXktY2EtY2VydA==
  - it: should generate TLS and CA certificates when `autoGenerated` is enabled and `engine` is set to `helm`
    set:
      tls:
        autoGenerated:
          enabled: true
          engine: helm
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-tls
      - matchRegex:
          path: "data['tls.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['tls.key']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['ca.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
  - it: should not re-generate certificates when `autoGenerated` is enabled and the alternative names have not changed
    set:
      tls:
        autoGenerated:
          enabled: true
          engine: helm
    kubernetesProvider:
      # Mock previously generated secret
      scheme:
        "v1/Secret":
          gvr:
            version: "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - kind: Secret
          apiVersion: v1
          type: kubernetes.io/tls
          metadata:
            name: RELEASE-NAME-kubernetes-access-gateway-tls
            namespace: NAMESPACE
            annotations:
              # sha256 hash of "[]-[]-" (no custom DNS names or resource alias is provided)
              checksum/alternativeNames: eee78e4712e57977935ceb9ebfdb354aa33c85ca4dbb490001827f64259b6b8d
          data:
            tls.crt: generated-cert
            tls.key: generated-key
            ca.crt: generated-ca
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-tls
      - equal:
          path: metadata.annotations
          value:
            # sha256 hash of "[]-[]-" (no custom DNS names or resource alias is provided)
            checksum/alternativeNames: eee78e4712e57977935ceb9ebfdb354aa33c85ca4dbb490001827f64259b6b8d
      - equal:
          path: data
          value:
            tls.crt: generated-cert
            tls.key: generated-key
            ca.crt: generated-ca
  - it: should re-generate certificates when `autoGenerated` is true but the alternative names have changed
    set:
      tls:
        autoGenerated:
          enabled: true
          engine: helm
        dnsNames:
          - my-cluster.int
    kubernetesProvider:
      # Mock previously generated secret
      scheme:
        "v1/Secret":
          gvr:
            version: "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - kind: Secret
          apiVersion: v1
          type: kubernetes.io/tls
          metadata:
            name: RELEASE-NAME-kubernetes-access-gateway-tls
            namespace: NAMESPACE
            annotations:
              # sha256 hash of "[]-[]-" (no custom DNS names or resource alias is provided)
              checksum/alternativeNames: eee78e4712e57977935ceb9ebfdb354aa33c85ca4dbb490001827f64259b6b8d
          data:
            tls.crt: generated-cert
            tls.key: generated-key
            ca.crt: generated-ca
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-tls
      - equal:
          path: metadata.annotations
          value:
            # sha256 hash of "[]-[my-cluster.int]-" (a custom DNS name is provided)
            checksum/alternativeNames: fd97b5b8e975253c40e6a8e5702abb9394e3b181d3b47873558d64fdaf8346fa
      - matchRegex:
          path: "data['tls.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['tls.key']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['ca.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
  - it: should re-generate certificates when `autoGenerated` is enabled and the resource alias has changed
    set:
      twingate:
        resource:
          enabled: true
          extraAnnotations:
            resource.twingate.com/alias: new-alias.int
      tls:
        autoGenerated:
          enabled: true
          engine: helm
    kubernetesProvider:
      # Mock previously generated secret
      scheme:
        "v1/Secret":
          gvr:
            version: "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - kind: Secret
          apiVersion: v1
          type: kubernetes.io/tls
          metadata:
            name: RELEASE-NAME-kubernetes-access-gateway-tls
            namespace: NAMESPACE
            annotations:
              # sha256 hash of "[]-[]-old-alias.int" (no custom DNS names or resource alias is provided)
              checksum/alternativeNames: 47c527febb8c858e4535dffa69c3c5b2921137e15f40eb66721be10d4c93121d
          data:
            tls.crt: generated-cert
            tls.key: generated-key
            ca.crt: generated-ca
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-kubernetes-access-gateway-tls
      - equal:
          path: metadata.annotations
          value:
            # sha256 hash of "[]-[]-new-alias.int" (a custom DNS name is provided)
            checksum/alternativeNames: 92aa860fe6d6fdc9d6e5d0f3f5d814a847f64e73722b663341e16b3f030e905f
      - matchRegex:
          path: "data['tls.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['tls.key']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
      - matchRegex:
          path: "data['ca.crt']"
          pattern: "^([A-Za-z0-9+/=]{20,})$"
  - it: should require `tls.cert` when `autoGenerated` is disabled
    set:
      tls:
        cert: null
        autoGenerated:
          enabled: false
    asserts:
      - failedTemplate:
          errorPattern: 'A valid .Values.tls.cert entry required!'
  - it: should require `tls.key` when `autoGenerated` is disabled
    set:
      tls:
        key: null
        autoGenerated:
          enabled: false
    asserts:
      - failedTemplate:
          errorPattern: 'A valid .Values.tls.key entry required!'
  - it: should require `ca.crt` when `autoGenerated` is disabled
    set:
      tls:
        ca: null
        autoGenerated:
          enabled: false
    asserts:
      - failedTemplate:
          errorPattern: 'A valid .Values.tls.ca entry required!'